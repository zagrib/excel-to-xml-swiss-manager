<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Swiss Manager ULTRA STABLE Tool</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:ui-sans-serif;background:#fff;padding:30px;color:#111}
.wrap{max-width:1100px;margin:auto;border:1px solid #e5e7eb;border-radius:12px;padding:20px}
.tabs{display:flex;gap:8px;margin:12px 0}
.tab{padding:6px 12px;border:1px solid #ddd;border-radius:8px;cursor:pointer}
.tab.active{background:#111;color:#fff}
textarea{width:100%;height:420px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-family:monospace}
button{background:#111;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;margin-right:6px}
.info{font-size:13px;color:#666;margin-top:8px}
</style>
</head>

<body>
<div class="wrap">

<h3>Swiss Manager ULTRA STABLE XML Generator</h3>

<input type="file" id="fileInput" accept=".xlsx,.xls">

<br><br>
<button onclick="loadFile()">LOAD FILE</button>
<button onclick="buildXML()">GENERATE XML</button>
<button onclick="downloadXML()">DOWNLOAD RAW XML</button>
<button onclick="copyXML()">COPY XML</button>

<div class="tabs">
<div class="tab active" onclick="setTab('ALL',this)">ALL</div>
<div class="tab" onclick="setTab('Teams',this)">Teams</div>
<div class="tab" onclick="setTab('Players',this)">Players</div>
<div class="tab" onclick="setTab('TeamCompositions',this)">TeamCompositions</div>
<div class="tab" onclick="setTab('Results',this)">Results</div>
</div>

<div class="info" id="status">Belum load file.</div>

<textarea id="output"></textarea>

</div>

<script>

let workbookGlobal=null;
let currentTab="ALL";
let lastXML="";

function esc(v){
 if(v===undefined||v===null) return "";
 return String(v)
  .replace(/&/g,"&amp;")
  .replace(/"/g,"&quot;")
  .replace(/</g,"&lt;")
  .replace(/>/g,"&gt;");
}

function rowsFromSheet(sheet){

 const raw=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
 let headers=raw[0]||[];

 headers=headers.map(h=>{
   if(h==="Nama") return "Firstname";
   return h;
 });

 const data=XLSX.utils.sheet_to_json(sheet,{defval:""});
 return {headers,data};
}

function buildTag(wb,sheetName,tagName,validator){

 if(!wb.Sheets[sheetName]) return "";

 const {headers,data}=rowsFromSheet(wb.Sheets[sheetName]);

 let count=0;
 let xml=`<${sheetName}>\n`;

 data.forEach((r,i)=>{

   if(!validator(r)) return;

   let attr="";

   headers.forEach(h=>{
     if(!h||!r[h]) return;
     attr+=` ${h}="${esc(r[h])}"`;
   });

   xml+=`  <${tagName}${attr}/>\n`;
   count++;
 });

 xml+=`</${sheetName}>\n`;

 document.getElementById("status").innerText =
   `Sheet ${sheetName}: ${count} valid rows`;

 return xml;
}

function buildXML(){

 if(!workbookGlobal){
   alert("Load file dulu.");
   return;
 }

 let xml='<?xml version="1.0" encoding="UTF-8"?>\n';

 if(currentTab==="ALL"||currentTab==="Teams"){
   xml+=buildTag(workbookGlobal,"Teams","Team",
     r=>r.TeamLongname&&r.TeamUniqueId);
 }

 if(currentTab==="ALL"||currentTab==="Players"){
   xml+=buildTag(workbookGlobal,"Players","Player",
     r=>r.PlayerUniqueId&&(r.Firstname||r.Nama));
 }

 if(currentTab==="ALL"||currentTab==="TeamCompositions"){
   xml+=buildTag(workbookGlobal,"TeamCompositions","TeamComposition",
     r=>r.Round&&r.Board&&(r.PlayerUniqueId||r.PlayerId||r.PlayerSNo));
 }

 if(currentTab==="ALL"||currentTab==="Results"){
   xml+=buildTag(workbookGlobal,"Results","Result",
     r=>r.Round&&(r.PlayerWhiteUniqueId||r.PlayerWhiteId||r.PlayerWhiteSNo));
 }

 lastXML=xml;
 document.getElementById("output").value=xml;
}

function loadFile(){

 const file=document.getElementById("fileInput").files[0];
 if(!file){
   alert("Pilih file dulu.");
   return;
 }

 const reader=new FileReader();

 reader.onload=function(evt){
   const data=new Uint8Array(evt.target.result);
   workbookGlobal=XLSX.read(data,{type:"array"});
   document.getElementById("status").innerText="File berhasil diload.";
 };

 reader.readAsArrayBuffer(file);
}

function setTab(tab,el){
 currentTab=tab;
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 el.classList.add("active");
}

function copyXML(){
 if(!lastXML) return alert("Belum generate XML.");
 navigator.clipboard.writeText(lastXML);
}

function downloadXML(){

 if(!lastXML){
   alert("Generate XML dulu.");
   return;
 }

 const blob=new Blob([lastXML],{type:"text/xml"});
 const url=URL.createObjectURL(blob);

 const a=document.createElement("a");
 a.href=url;
 a.download="swiss-manager-export.xml";
 a.click();

 URL.revokeObjectURL(url);
}

</script>
</body>
</html>
